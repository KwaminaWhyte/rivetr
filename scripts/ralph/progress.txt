# Ralph Progress Log
Started: 01/10/2026 11:27:17 (Team Flow PRD)
---

## Codebase Patterns
- Team context is managed via React Context in frontend/app/lib/team-context.tsx
- TeamSwitcher component already exists at frontend/app/components/team-switcher.tsx
- API core supports X-Team-Id header via ApiRequestOptions.teamId
- Dashboard layout (_layout.tsx) wraps authenticated routes with TeamProvider
- Container runtime abstraction is in src/runtime/mod.rs (DockerRuntime, PodmanRuntime)
- API routes use Axum in src/api/
- Database uses SQLite with SQLx, migrations in migrations/
- Frontend is React + TypeScript + shadcn/ui in frontend/
- Use anyhow::Result for error handling in Rust code
- State management uses AppState in src/lib.rs with ArcSwap for lock-free updates
- 2 pre-existing test failures in pack_builder and preview modules are unrelated to new work
- Frontend has no "lint" script - use "npm run build" for quality checks
- To auto-open dialogs from URL, use useSearchParams with ?create=true pattern
- System email config is in EmailConfig (src/config/mod.rs), use SystemEmailService (src/notifications/email.rs)
- Email sending is non-blocking: log errors but don't fail requests if email fails
- Use server.external_url from config for building callback URLs (supports ngrok/tunnels)
- Team audit logs use log_team_audit() helper in src/api/teams.rs
- TeamAuditAction/TeamAuditResourceType enums defined in src/db/models/team.rs
- Pagination pattern: page (1-indexed), per_page with clamp(1, 100), offset = (page-1)*per_page
- TeamDetail includes user_role for current user's role in the team (added in US-016)

---

## 01/10/2026 - US-001
- Created TeamProvider context (frontend/app/lib/team-context.tsx)
  - Stores currentTeamId in React state
  - Persists to localStorage with key 'rivetr_current_team'
  - Loads last active team on mount, or first team if none saved
  - Invalidates relevant queries on team switch (apps, projects, databases, services, stats)
- Updated API core (frontend/app/lib/api/core.ts)
  - Added ApiRequestOptions interface with optional teamId
  - Added X-Team-Id header support for team-scoped requests
- Integrated TeamSwitcher into sidebar (frontend/app/components/app-sidebar.tsx)
  - Connected existing TeamSwitcher component to team context
- Wrapped dashboard layout with TeamProvider
- **Learnings for future iterations:**
  - TeamSwitcher component already existed and was well-designed
  - Pre-existing test failures in pack_builder and preview modules
  - Frontend uses React Query with query invalidation on context changes
---

## 01/10/2026 - US-002
- Enhanced TeamSwitcher component (frontend/app/components/team-switcher.tsx)
  - Added role badges next to team names with variant styling:
    - owner: "default" variant (primary color)
    - admin: "secondary" variant
    - developer/viewer: "outline" variant
  - Added "Create Team" option at bottom of dropdown
  - Uses Badge component from shadcn/ui
- Updated teams settings page (frontend/app/routes/settings/teams.tsx)
  - Added ?create=true query parameter handling
  - Auto-opens create dialog when navigating from team switcher
  - Uses useSearchParams hook from react-router
- Files changed:
  - frontend/app/components/team-switcher.tsx
  - frontend/app/routes/settings/teams.tsx
- **Learnings for future iterations:**
  - TeamWithMemberCount type already includes user_role field
  - Frontend has no "lint" script - use "typecheck" or "build" instead
  - Pre-existing TypeScript errors in github-repo-picker.tsx don't break build
  - Badge component supports "default", "secondary", "outline" variants
---

## 01/10/2026 - US-003
- Added team_id field to Rust App model (src/db/models/app.rs)
  - Added team_id to App struct
  - Added team_id to AppResponse DTO
  - Added team_id to CreateAppRequest DTO
  - Updated From<App> for AppResponse implementation
- Modified GET /api/apps endpoint (src/api/apps.rs)
  - Added ListAppsQuery struct with optional team_id parameter
  - Filter by team_id when provided
  - Return all apps when no team_id filter (backward compatibility)
  - Support empty string team_id to get legacy/unassigned apps
- Updated app creation INSERT query to include team_id column
- Updated frontend API (frontend/app/lib/api/apps.ts)
  - Modified getApps to accept optional teamId parameter
  - Pass team_id as query parameter
- Updated frontend components to pass team context:
  - nav-apps.tsx - uses currentTeamId from useTeamContext
  - projects/_index.tsx - filters apps by current team
  - projects/$id.tsx - filters allApps by current team
  - settings/notifications.tsx - filters apps for subscription
- Updated frontend types (frontend/app/types/api.ts)
  - Added team_id to App interface
  - Added team_id to CreateAppRequest interface
- Updated server-side API (frontend/app/lib/api.server.ts)
  - Added optional teamId parameter to getApps
- Files changed:
  - src/api/apps.rs
  - src/db/models/app.rs
  - frontend/app/components/nav-apps.tsx
  - frontend/app/lib/api/apps.ts
  - frontend/app/lib/api.server.ts
  - frontend/app/routes/projects/_index.tsx
  - frontend/app/routes/projects/$id.tsx
  - frontend/app/routes/settings/notifications.tsx
  - frontend/app/types/api.ts
- **Learnings for future iterations:**
  - Apps table already has team_id column from migration 015_teams.sql
  - Query extractor requires explicit serde::Deserialize derive on query structs
  - React Query keys should include team_id to trigger refetch on team switch
  - enabled: currentTeamId !== null prevents queries before team loads
---

## 01/10/2026 - US-004
- Added team_id field to Rust Project models (src/db/models/project.rs)
  - Added team_id to Project struct
  - Added team_id to ProjectWithAppCount DTO
  - Added team_id to ProjectWithApps DTO
  - Added team_id to CreateProjectRequest DTO
- Modified GET /api/projects endpoint (src/api/projects.rs)
  - Added ListProjectsQuery struct with optional team_id parameter
  - Filter by team_id when provided
  - Return all projects when no team_id filter (backward compatibility)
  - Support empty string team_id to get legacy/unassigned projects
- Updated project creation INSERT query to include team_id column
- Updated frontend API (frontend/app/lib/api/projects.ts)
  - Modified getProjects to accept optional teamId parameter
  - Pass team_id as query parameter
- Updated frontend pages to pass team context:
  - projects/_index.tsx - passes currentTeamId to getProjects and createProject
  - projects/$project-id.apps.new.tsx - filters projects by current team for dropdown
- Updated frontend types (frontend/app/types/api.ts)
  - Added team_id to Project interface
  - Added team_id to CreateProjectRequest interface
- Updated server-side API (frontend/app/lib/api.server.ts)
  - Added optional teamId parameter to getProjects
- Files changed:
  - src/api/projects.rs
  - src/db/models/project.rs
  - frontend/app/lib/api/projects.ts
  - frontend/app/lib/api.server.ts
  - frontend/app/routes/projects/_index.tsx
  - frontend/app/routes/projects/$project-id.apps.new.tsx
  - frontend/app/types/api.ts
- **Learnings for future iterations:**
  - Projects table already has team_id column from migration 015_teams.sql (same as apps)
  - Pattern for team filtering is consistent: add ListXxxQuery struct, optional team_id, use match expression
  - Frontend pattern: add teamId param to API function, include in query key, set enabled: currentTeamId !== null
---

## 01/10/2026 - US-005
- Created migration 032_databases_team.sql
  - Added team_id column to databases table
  - Created index idx_databases_team_id for faster lookups
- Added team_id field to Rust ManagedDatabase model (src/db/models/database.rs)
  - Added team_id to ManagedDatabase struct
  - Added team_id to ManagedDatabaseResponse DTO
  - Added team_id to CreateManagedDatabaseRequest DTO
  - Updated to_response method to include team_id
- Modified GET /api/databases endpoint (src/api/databases.rs)
  - Added team_id to ListQuery struct
  - Filter by team_id when provided
  - Return all databases when no team_id filter (backward compatibility)
  - Support empty string team_id to get legacy/unassigned databases
- Updated database creation INSERT query to include team_id column
- Updated frontend API (frontend/app/lib/api/databases.ts)
  - Modified getDatabases to accept options object with optional teamId
  - Pass team_id as query parameter using URLSearchParams
- Updated frontend pages to pass team context:
  - projects/_index.tsx - passes currentTeamId to getDatabases
  - projects/$id.tsx - passes currentTeamId to createDatabase
- Updated frontend types (frontend/app/types/api.ts)
  - Added team_id to ManagedDatabase interface
  - Added team_id to CreateManagedDatabaseRequest interface
- Updated server-side API (frontend/app/lib/api.server.ts)
  - Modified getDatabases to accept options object with teamId
- Files changed:
  - migrations/032_databases_team.sql (new)
  - src/api/databases.rs
  - src/db/models/database.rs
  - frontend/app/lib/api/databases.ts
  - frontend/app/lib/api.server.ts
  - frontend/app/routes/projects/_index.tsx
  - frontend/app/routes/projects/$id.tsx
  - frontend/app/types/api.ts
- **Learnings for future iterations:**
  - Unlike apps and projects, databases table did NOT have team_id column - required new migration
  - getDatabases needed signature change from (reveal, token) to (options, token) to add teamId
  - Pattern is consistent with apps/projects: ListQuery struct, filter by team_id, frontend passes currentTeamId
---

## 01/10/2026 - US-006
- Created migration 033_services_team.sql
  - Added team_id column to services table
  - Created index idx_services_team_id for faster lookups
- Added team_id field to Rust Service model (src/db/models/service.rs)
  - Added team_id to Service struct
  - Added team_id to ServiceResponse DTO
  - Added team_id to CreateServiceRequest DTO
  - Updated From<Service> for ServiceResponse implementation
- Modified GET /api/services endpoint (src/api/services.rs)
  - Added ListServicesQuery struct with optional team_id parameter
  - Filter by team_id when provided
  - Return all services when no team_id filter (backward compatibility)
  - Support empty string team_id to get legacy/unassigned services
- Updated service creation INSERT query to include team_id column
- Updated frontend API (frontend/app/lib/api/services.ts)
  - Added GetServicesOptions interface with optional teamId
  - Modified getServices to accept options object and pass team_id query param
- Updated frontend page to pass team context:
  - services/_index.tsx - uses currentTeamId from useTeamContext
  - Passes currentTeamId to getServices query
  - Passes team_id in createService mutation
- Updated frontend types (frontend/app/types/api.ts)
  - Added team_id to Service interface
  - Added team_id to CreateServiceRequest interface
- Updated server-side API (frontend/app/lib/api.server.ts)
  - Modified getServices to accept options object with teamId
- Files changed:
  - migrations/033_services_team.sql (new)
  - src/api/services.rs
  - src/db/models/service.rs
  - frontend/app/lib/api/services.ts
  - frontend/app/lib/api.server.ts
  - frontend/app/routes/services/_index.tsx
  - frontend/app/types/api.ts
- **Learnings for future iterations:**
  - Services table did NOT have team_id column - required new migration (same as databases)
  - Pattern is fully consistent: ListXxxQuery struct, filter by team_id, frontend uses currentTeamId
  - Services follow exact same pattern as apps, projects, and databases for team filtering
---

## 01/10/2026 - US-007
- Created migration 034_team_invitations.sql
  - team_invitations table with id, team_id, email, role, token, expires_at, accepted_at, created_by, created_at
  - Unique index on token for fast lookups
  - Unique index on (team_id, email) WHERE accepted_at IS NULL to prevent duplicate pending invitations
- Added TeamInvitation model (src/db/models/team.rs)
  - TeamInvitation struct with is_expired() and is_accepted() helper methods
  - TeamInvitationResponse DTO with team_name and inviter_name for display
  - CreateInvitationRequest DTO for creating invitations
- Added invitation endpoints (src/api/teams.rs)
  - list_invitations: GET /api/teams/{id}/invitations - list pending invitations (admin+ only)
  - create_invitation: POST /api/teams/{id}/invitations - create invitation (admin+ only)
  - delete_invitation: DELETE /api/teams/{id}/invitations/{id} - revoke invitation
  - validate_invitation: GET /api/auth/invitations/{token} - validate invitation (public)
  - accept_invitation: POST /api/invitations/{token}/accept - accept invitation (authenticated)
- Added routes to src/api/mod.rs
  - Protected routes under /api for list, create, delete, accept
  - Public route under /api/auth for validation
- Security features:
  - 48-character secure random tokens
  - 7-day expiration
  - Email matching on accept (case-insensitive)
  - Role hierarchy enforced (admins can't assign owner role)
- Files changed:
  - migrations/034_team_invitations.sql (new)
  - src/api/teams.rs
  - src/api/mod.rs
  - src/db/mod.rs (added migration 034)
  - src/db/models/team.rs
- **Learnings for future iterations:**
  - Invitation tokens should be long (48+ chars) for security
  - Use chrono::Duration for date calculations
  - SQLite unique partial indexes (WHERE clause) work for preventing duplicate pending invitations
  - Public endpoints go in auth_routes, protected in api_routes
  - rand::rng() and random_range() for secure random generation
---

## 01/10/2026 - US-008
- Added EmailConfig to main config (src/config/mod.rs)
  - enabled, smtp_host, smtp_port, smtp_username, smtp_password, smtp_tls, from_address, from_name
  - is_configured() helper method to check if email is properly set up
  - Default: email disabled, port 587, TLS enabled
- Created SystemEmailService (src/notifications/email.rs)
  - send_invitation_email() for team invitations
  - HTML template with professional styling (gradient header, detail cards, CTA button)
  - Plain text fallback for email clients that don't support HTML
  - Uses lettre crate for SMTP (already a dependency)
  - HTML escaping for user input to prevent XSS
- Integrated email sending into invitation creation (src/api/teams.rs)
  - Email sent after invitation created in database
  - Non-blocking: logs errors but doesn't fail the request
  - Accept URL uses server.external_url config or localhost:8080
- Added resend_invitation endpoint
  - POST /api/teams/:id/invitations/:inv_id/resend
  - Validates invitation is pending and not expired
  - Requires admin+ role
  - Returns 400 if email not configured
- Updated rivetr.example.toml with email configuration documentation
- Files changed:
  - src/config/mod.rs (added EmailConfig)
  - src/notifications/mod.rs (added email module export)
  - src/notifications/email.rs (new - SystemEmailService)
  - src/api/teams.rs (email sending in create_invitation, resend_invitation endpoint)
  - src/api/mod.rs (added resend route)
  - rivetr.example.toml (email config docs)
- **Learnings for future iterations:**
  - Email config goes in main config, not notification_channels (those are user-configured)
  - Use server.external_url for building accept URLs (supports ngrok/tunnels)
  - Email templates should have both HTML and plain text versions
  - Don't fail requests if email fails - just log the error
  - lettre crate already available in project for SMTP
---

## 01/10/2026 - US-009
- Added TeamInvitation type and CreateInvitationRequest to frontend types (frontend/app/types/api.ts)
  - TeamInvitation: id, team_id, email, role, expires_at, accepted_at, created_by, created_at, team_name, inviter_name
  - CreateInvitationRequest: email, role
- Added invitation API functions to teams API (frontend/app/lib/api/teams.ts)
  - getTeamInvitations: GET /teams/{id}/invitations
  - createTeamInvitation: POST /teams/{id}/invitations
  - deleteTeamInvitation: DELETE /teams/{id}/invitations/{id}
  - resendTeamInvitation: POST /teams/{id}/invitations/{id}/resend
- Updated api index to export new invitation functions
- Rewrote team detail page with Tabs component (frontend/app/routes/settings/teams/$id.tsx)
  - Added Members tab (existing functionality)
  - Added Invitations tab (admin+ users only)
  - Invitations tab includes:
    - Send Invitation card with email input and role selector
    - Pending Invitations table showing email, role, sent date, expiry
    - Resend button (RefreshCw icon) to re-send invitation email
    - Revoke button (Trash2 icon) with confirmation dialog
  - URL supports ?tab=invitations query param for deep linking
- Files changed:
  - frontend/app/types/api.ts (added TeamInvitation, CreateInvitationRequest)
  - frontend/app/lib/api/teams.ts (added invitation API functions)
  - frontend/app/lib/api/index.ts (exported new functions)
  - frontend/app/routes/settings/teams/$id.tsx (added Invitations tab)
- **Learnings for future iterations:**
  - Tabs component from shadcn/ui works well for adding sections to detail pages
  - Use useSearchParams to sync tab state with URL
  - formatRelativeTime helper is useful for expiry dates
  - Filter pending invitations client-side: !accepted_at && !isExpired(expires_at)
  - Query key pattern: ["team-invitations", teamId] for invitation cache
- Public routes are defined outside the layout() block in routes.ts
- Use localStorage rivetr_return_url for post-login redirect (invitation accept flow)
---

## 01/10/2026 - US-010
- Created invitation accept route (frontend/app/routes/invitations/accept.tsx)
  - Route: /invitations/accept?token=xxx
  - Validates invitation token via GET /api/auth/invitations/{token}
  - Shows invitation details: team name, role, inviter
  - Handles multiple states:
    - Loading: Shows spinner while validating
    - Not found: Invalid or removed invitation
    - Expired: Shows "invitation expired" with team name
    - Already accepted: Shows "already accepted" with dashboard link
    - Valid (logged in): Shows accept button that POSTs to /api/invitations/{token}/accept
    - Valid (logged out): Shows login button that stores return URL
  - After accept, redirects to /settings/teams/{team_id}
  - Error handling for: already a member, email mismatch
- Added API functions to teams API (frontend/app/lib/api/teams.ts)
  - validateInvitation: GET /auth/invitations/{token} (public)
  - acceptInvitation: POST /invitations/{token}/accept (authenticated)
- Updated api index to export new functions
- Updated routes.ts to add public route for /invitations/accept
- Updated login page (frontend/app/routes/login.tsx)
  - Checks for rivetr_return_url in localStorage after successful login
  - Redirects to return URL if present, otherwise to dashboard
- Files changed:
  - frontend/app/routes/invitations/accept.tsx (new)
  - frontend/app/lib/api/teams.ts (added validateInvitation, acceptInvitation)
  - frontend/app/lib/api/index.ts (exported new functions)
  - frontend/app/routes.ts (added invitations/accept route)
  - frontend/app/routes/login.tsx (return URL handling)
- **Learnings for future iterations:**
  - Public routes go outside the layout() block in routes.ts
  - Use localStorage to persist return URL across login redirect
  - Backend already handles all validation (expired, accepted, email match)
  - Use useMutation for accept action, useEffect for initial validation
  - Card/CardHeader/CardContent/CardFooter provides clean invite UI structure
---

## 01/10/2026 - US-011
- Created migration 035_team_audit_logs.sql
  - team_audit_logs table with id, team_id, user_id, action, resource_type, resource_id, details, created_at
  - Foreign key to teams table with CASCADE delete
  - Indexes on team_id, user_id, action, resource_type, created_at
  - Composite index on team_id + created_at for common queries
- Added TeamAuditAction enum (src/db/models/team.rs)
  - 23 action types: TeamCreated, TeamUpdated, TeamDeleted, MemberInvited, MemberJoined, MemberRemoved, RoleChanged, InvitationCreated, InvitationRevoked, InvitationAccepted, InvitationResent, AppCreated, AppUpdated, AppDeleted, ProjectCreated, ProjectUpdated, ProjectDeleted, DatabaseCreated, DatabaseDeleted, ServiceCreated, ServiceDeleted, DeploymentTriggered, DeploymentRolledBack
- Added TeamAuditResourceType enum
  - 8 types: Team, Member, Invitation, App, Project, Database, Service, Deployment
- Added TeamAuditLog, TeamAuditLogResponse, TeamAuditLogPage structs
- Added log_team_audit helper function (src/api/teams.rs)
  - Accepts pool, team_id, user_id, action, resource_type, resource_id, details
  - Creates audit log entry with JSON details
- Added audit logging to team operations:
  - create_team: logs TeamCreated
  - invite_member: logs MemberJoined
  - update_member_role: logs RoleChanged (includes old_role/new_role)
  - remove_member: logs MemberRemoved (includes self_removal flag)
  - create_invitation: logs InvitationCreated
  - delete_invitation: logs InvitationRevoked
  - accept_invitation: logs InvitationAccepted
- Added GET /api/teams/{id}/audit-logs endpoint
  - Admin+ role required
  - Pagination: page (1-indexed), per_page (default 20, max 100)
  - Filters: action, resource_type, start_date, end_date
  - Returns TeamAuditLogPage with items, total, page, per_page, total_pages
  - Each item includes user_name and user_email for display
  - Details parsed as JSON for frontend consumption
- Files changed:
  - migrations/035_team_audit_logs.sql (new)
  - src/api/teams.rs (log_team_audit, audit logging, list_audit_logs endpoint)
  - src/api/mod.rs (added audit-logs route)
  - src/db/mod.rs (added migration 035)
  - src/db/models/team.rs (TeamAuditAction, TeamAuditResourceType, structs)
- **Learnings for future iterations:**
  - Use helper function pattern for audit logging to DRY repeated code
  - Dynamic SQL with match statements for optional filters (simpler than query builder)
  - Foreign key with CASCADE ensures audit logs deleted when team deleted
  - Details field stores JSON as string, parsed to serde_json::Value on response
  - Pagination pattern: page (1-indexed), per_page with clamp, offset = (page-1)*per_page
---

## 01/10/2026 - US-012
- Added team-level audit logging to all resource operations
- Updated imports in 5 API files to include TeamAuditAction, TeamAuditResourceType, log_team_audit
- Added audit logging to apps.rs:
  - create_app: logs AppCreated with app_name, git_url, branch
  - update_app: logs AppUpdated with app_name
  - delete_app: logs AppDeleted with app_name
  - upload_create_app: logs AppCreated with app_name, source=upload, build_type
- Added audit logging to deployments.rs:
  - trigger_deploy: logs DeploymentTriggered with app_id, app_name
  - upload_deploy: logs DeploymentTriggered with app_id, app_name, source=upload, build_type
  - rollback_deployment: logs DeploymentRolledBack with app_id, app_name, target_deployment_id
- Added audit logging to databases.rs:
  - create_database: logs DatabaseCreated with database_name, db_type, version
  - delete_database: logs DatabaseDeleted with database_name
- Added audit logging to services.rs:
  - create_service: logs ServiceCreated with service_name
  - delete_service: logs ServiceDeleted with service_name
- Added audit logging to projects.rs:
  - create_project: logs ProjectCreated with project_name
  - delete_project: logs ProjectDeleted with project_name
- All audit logs only created when resource has team_id (team-scoped resources)
- All audit logs include actor user_id
- Files changed:
  - src/api/apps.rs
  - src/api/databases.rs
  - src/api/deployments.rs
  - src/api/projects.rs
  - src/api/services.rs
- **Learnings for future iterations:**
  - log_team_audit helper already defined in src/api/teams.rs - just import and use
  - Use "if let Some(ref team_id) = resource.team_id" pattern to conditionally log
  - Always wrap log_team_audit in "if let Err(e) = " to not fail request on audit log failure
  - Audit log failures should be logged as warnings, not errors (non-critical)
  - All TeamAuditAction and TeamAuditResourceType variants already defined in src/db/models/team.rs
---

## 01/10/2026 - US-013
- Added TeamAuditLog types to frontend/app/types/api.ts
  - TeamAuditAction: 23 action type values
  - TeamAuditResourceType: 8 resource types
  - TeamAuditLog: full log entry with user details
  - TeamAuditLogPage: paginated response
  - TeamAuditLogQuery: query parameters for filtering
- Added getTeamAuditLogs API function to frontend/app/lib/api/teams.ts
  - Builds query string from optional filters
  - Supports action, resource_type, start_date, end_date, page, per_page
- Added Activity tab to team settings page (frontend/app/routes/settings/teams/$id.tsx)
  - Tab only visible to admin+ users (same as Invitations tab)
  - Filter controls:
    - Action type dropdown (23 options from AUDIT_ACTION_OPTIONS)
    - Resource type dropdown (8 options from AUDIT_RESOURCE_TYPE_OPTIONS)
    - Date range with start/end date inputs
    - Clear filters button when any filter is active
  - Audit log table with columns: Timestamp, User, Action (badge), Resource, Details
  - Action badges color-coded: destructive for deletions, default for creations, secondary for updates
  - Pagination controls with Previous/Next buttons and page info
  - Query only fetches when Activity tab is active (enabled: activeTab === "activity")
- Helper functions added:
  - formatActionLabel: converts snake_case to Title Case
  - getActionBadgeVariant: determines badge color based on action type
- Files changed:
  - frontend/app/types/api.ts
  - frontend/app/lib/api/teams.ts
  - frontend/app/lib/api/index.ts
  - frontend/app/routes/settings/teams/$id.tsx
- **Learnings for future iterations:**
  - Frontend audit log types mirror backend TeamAuditLogResponse struct
  - useQuery with enabled flag prevents unnecessary API calls when tab not active
  - Query key includes filter object so React Query refetches on filter change
  - Date inputs need conversion to ISO 8601 for API (new Date(date).toISOString())
  - Audit log details are shown as key-value pairs, filtering out IDs for cleaner display
---

## 01/10/2026 - US-014
- Created migration 036_app_shares.sql
  - app_shares table with id, app_id, shared_with_team_id, permission, created_at, created_by
  - Unique index on (app_id, shared_with_team_id) to prevent duplicate shares
  - Foreign keys to apps, teams, and users tables with CASCADE delete
- Added app sharing models to src/db/models/app.rs
  - AppShare: Raw database model
  - AppShareResponse: DTO with team name and creator name
  - CreateAppShareRequest: Request DTO for creating shares
  - AppWithSharing: App with is_shared flag and owner_team_name
- Added sharing endpoints to src/api/apps.rs
  - list_app_shares: GET /api/apps/:id/shares - list teams app is shared with
  - create_app_share: POST /api/apps/:id/shares - share app with a team
  - delete_app_share: DELETE /api/apps/:id/shares/:team_id - remove sharing
  - list_apps_with_sharing: GET /api/apps/with-sharing?team_id=xxx - list owned + shared apps
- Added routes to src/api/mod.rs
- Includes audit logging for share/unshare operations
- Files changed:
  - migrations/036_app_shares.sql (new)
  - src/api/apps.rs
  - src/api/mod.rs
  - src/db/mod.rs
  - src/db/models/app.rs
- **Learnings for future iterations:**
  - SQLx FromRow doesn't support tuples with > 16 elements - use multiple queries instead
  - App shares use "view" permission by default (only option currently supported)
  - list_apps_with_sharing is useful for frontend to get owned + shared apps in one call
  - Audit logs use AppUpdated action for share/unshare with "action" field in details JSON
---

## 01/10/2026 - US-015
- Added app sharing frontend types to frontend/app/types/api.ts
  - AppShare: Response DTO with team name and creator details
  - CreateAppShareRequest: Request DTO for sharing
  - AppWithSharing: App with is_shared flag and owner_team_name
- Added app sharing API functions to frontend/app/lib/api/apps.ts
  - getAppShares: GET /apps/:id/shares
  - createAppShare: POST /apps/:id/shares
  - deleteAppShare: DELETE /apps/:id/shares/:team_id
  - getAppsWithSharing: GET /apps/with-sharing?team_id=xxx
- Created AppSharingCard component (frontend/app/components/app-sharing-card.tsx)
  - Shows list of teams app is shared with (table with team name, permission, date, creator)
  - Team selector dropdown to share with other teams
  - Remove sharing button with confirmation dialog
  - Only visible for app owner (not shown for shared apps)
  - Uses React Query for data fetching and mutations
- Added Sharing tab to app settings page (frontend/app/routes/apps/$id/settings.tsx)
  - Added 6th tab "Sharing" to TabsList (grid-cols-6)
  - AppSharingCard rendered in Sharing tab content
- Updated nav-apps.tsx to show shared badge
  - Uses getAppsWithSharing endpoint instead of getApps
  - Shows Share2 icon (blue) for shared apps, Package icon for owned
  - Shows "Shared" badge next to shared app names
  - Hides Deploy and Delete actions for shared apps (view-only)
- Files changed:
  - frontend/app/types/api.ts
  - frontend/app/lib/api/apps.ts
  - frontend/app/components/app-sharing-card.tsx (new)
  - frontend/app/routes/apps/$id/settings.tsx
  - frontend/app/components/nav-apps.tsx
- **Learnings for future iterations:**
  - AppWithSharing type extends App with is_shared and owner_team_name for list views
  - getAppsWithSharing returns both owned and shared apps in one call
  - Use Share2 icon for shared items to visually distinguish from owned
  - Hide modification actions (deploy, delete) for shared apps
  - Only show sharing card for app owner (check app.team_id === currentTeamId)
---

## 01/10/2026 - US-016
- Added user_role field to TeamDetail in backend (src/db/models/team.rs)
  - Added user_role: Option<String> field
- Updated get_team endpoint to include user's role (src/api/teams.rs)
  - Changed _membership to membership to use the role
  - Added user_role: Some(membership.role) to response
- Added user_role to TeamDetail interface in frontend (frontend/app/types/api.ts)
  - user_role: TeamRole | null
- Fixed currentUserRole logic in team settings page (frontend/app/routes/settings/teams/$id.tsx)
  - Changed from broken logic (finding any owner) to team?.user_role
- Added role change confirmation dialog
  - New state: showRoleChangeDialog, pendingRoleChange
  - AlertDialog with contextual warnings (promoting to owner, demoting from admin)
  - confirmRoleChange function handles mutation with success/error cleanup
- Improved role dropdown logic
  - Only shows for members current user can manage
  - Owners can change any non-owner role
  - Admins can only change developer/viewer roles
  - Changed dropdown options: admins can't see owner or admin options
- Files changed:
  - src/db/models/team.rs
  - src/api/teams.rs
  - frontend/app/types/api.ts
  - frontend/app/routes/settings/teams/$id.tsx
- **Learnings for future iterations:**
  - TeamDetail didn't include user_role - needed to add it to get current user's role
  - Backend already had last owner protection in update_member_role
  - Use controlled Select (value={} instead of defaultValue) for confirmation dialog flow
  - Role management logic: show dropdown only for members user can manage, not just non-owners
---

## 01/10/2026 - US-017
- Updated remove button visibility logic in team settings page
  - Owners can remove any member (backend validates last owner)
  - Admins can only remove developers and viewers
  - Added title="Remove member" for accessibility
- Remove button and confirmation dialog already existed from earlier implementation
- Backend remove_member endpoint already has:
  - Permission checks (role hierarchy)
  - Last owner validation with clear error message
  - Audit logging (MemberRemoved action)
- Files changed:
  - frontend/app/routes/settings/teams/$id.tsx
- **Learnings for future iterations:**
  - Remove button logic was overly restrictive (prevented removing ANY owner)
  - Backend handles last owner case - frontend just needs to allow the action
  - Role hierarchy for removals: owners can remove anyone, admins can only remove lower roles
  - Existing confirmation dialog pattern works well - shows member name and warns about access loss
---

## 01/10/2026 - US-018
- Added team_id parameter to GET /api/system/stats endpoint (src/api/system.rs)
  - Created SystemStatsQuery struct with optional team_id
  - Filters apps by team_id when provided
  - Filters deployments by joining with apps table filtered by team_id
  - Filters databases by team_id when provided
  - Filters services by team_id when provided
  - Returns system-wide stats when no team_id filter
- Updated frontend system API (frontend/app/lib/api/system.ts)
  - Added GetSystemStatsOptions interface with optional teamId
  - Modified getSystemStats to build query string with team_id parameter
- Updated dashboard page (frontend/app/routes/_index.tsx)
  - Added useTeamContext hook
  - Pass currentTeamId to getSystemStats query
  - Added currentTeamId to query key for cache invalidation
  - Set enabled: currentTeamId !== null to prevent queries before team loads
- Updated monitoring page (frontend/app/routes/monitoring.tsx)
  - Same changes as dashboard page
- Files changed:
  - src/api/system.rs
  - frontend/app/lib/api/system.ts
  - frontend/app/routes/_index.tsx
  - frontend/app/routes/monitoring.tsx
- **Learnings for future iterations:**
  - Dashboard stats now team-scoped - switching teams updates all stat counts
  - Cost summary doesn't exist yet - acceptance criteria item not applicable
  - Container stats (CPU, memory) aggregate across team's resources
  - Query key pattern includes currentTeamId for proper cache invalidation
---

## 01/10/2026 - US-019
- Added CLI command `rivetr db migrate-teams` for migrating unassigned resources (src/cli/mod.rs)
  - DbCommands enum with MigrateTeams subcommand
  - --execute flag for actual migration (without it, shows dry-run)
- cmd_migrate_teams function implementation:
  - Connects directly to SQLite database using config
  - Queries unassigned apps, projects, databases, services (WHERE team_id IS NULL)
  - For each user with unassigned resources, finds their first team (by membership created_at)
  - Migrates resources by UPDATE ... SET team_id = ?
  - Displays user info (name, email), target team, and resource details
  - Tracks and displays migration statistics (apps/projects/databases/services count)
  - Warns about users without team membership (resources remain unassigned)
  - Provides instructions for running with --execute flag
- Files changed:
  - src/cli/mod.rs (DbCommands enum, cmd_migrate_teams function)
- **Learnings for future iterations:**
  - CLI commands can connect directly to database without running full server
  - Use dry-run mode by default for destructive operations
  - User's first team determined by team_members.created_at ASC
  - sqlx::query_as with tuple types (String, String, String) works for simple queries
  - HashSet for collecting unique user IDs efficiently
  - Format user display as "name (email)" for clear identification
---

