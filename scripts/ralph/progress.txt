# Ralph Progress Log
Started: 01/10/2026 11:27:17 (Team Flow PRD)
---

## Codebase Patterns
- Team context is managed via React Context in frontend/app/lib/team-context.tsx
- TeamSwitcher component already exists at frontend/app/components/team-switcher.tsx
- API core supports X-Team-Id header via ApiRequestOptions.teamId
- Dashboard layout (_layout.tsx) wraps authenticated routes with TeamProvider
- Container runtime abstraction is in src/runtime/mod.rs (DockerRuntime, PodmanRuntime)
- API routes use Axum in src/api/
- Database uses SQLite with SQLx, migrations in migrations/
- Frontend is React + TypeScript + shadcn/ui in frontend/
- Use anyhow::Result for error handling in Rust code
- State management uses AppState in src/lib.rs with ArcSwap for lock-free updates
- 2 pre-existing test failures in pack_builder and preview modules are unrelated to new work
- Frontend has no "lint" script - use "npm run build" for quality checks
- To auto-open dialogs from URL, use useSearchParams with ?create=true pattern

---

## 01/10/2026 - US-001
- Created TeamProvider context (frontend/app/lib/team-context.tsx)
  - Stores currentTeamId in React state
  - Persists to localStorage with key 'rivetr_current_team'
  - Loads last active team on mount, or first team if none saved
  - Invalidates relevant queries on team switch (apps, projects, databases, services, stats)
- Updated API core (frontend/app/lib/api/core.ts)
  - Added ApiRequestOptions interface with optional teamId
  - Added X-Team-Id header support for team-scoped requests
- Integrated TeamSwitcher into sidebar (frontend/app/components/app-sidebar.tsx)
  - Connected existing TeamSwitcher component to team context
- Wrapped dashboard layout with TeamProvider
- **Learnings for future iterations:**
  - TeamSwitcher component already existed and was well-designed
  - Pre-existing test failures in pack_builder and preview modules
  - Frontend uses React Query with query invalidation on context changes
---

## 01/10/2026 - US-002
- Enhanced TeamSwitcher component (frontend/app/components/team-switcher.tsx)
  - Added role badges next to team names with variant styling:
    - owner: "default" variant (primary color)
    - admin: "secondary" variant
    - developer/viewer: "outline" variant
  - Added "Create Team" option at bottom of dropdown
  - Uses Badge component from shadcn/ui
- Updated teams settings page (frontend/app/routes/settings/teams.tsx)
  - Added ?create=true query parameter handling
  - Auto-opens create dialog when navigating from team switcher
  - Uses useSearchParams hook from react-router
- Files changed:
  - frontend/app/components/team-switcher.tsx
  - frontend/app/routes/settings/teams.tsx
- **Learnings for future iterations:**
  - TeamWithMemberCount type already includes user_role field
  - Frontend has no "lint" script - use "typecheck" or "build" instead
  - Pre-existing TypeScript errors in github-repo-picker.tsx don't break build
  - Badge component supports "default", "secondary", "outline" variants
---

## 01/10/2026 - US-003
- Added team_id field to Rust App model (src/db/models/app.rs)
  - Added team_id to App struct
  - Added team_id to AppResponse DTO
  - Added team_id to CreateAppRequest DTO
  - Updated From<App> for AppResponse implementation
- Modified GET /api/apps endpoint (src/api/apps.rs)
  - Added ListAppsQuery struct with optional team_id parameter
  - Filter by team_id when provided
  - Return all apps when no team_id filter (backward compatibility)
  - Support empty string team_id to get legacy/unassigned apps
- Updated app creation INSERT query to include team_id column
- Updated frontend API (frontend/app/lib/api/apps.ts)
  - Modified getApps to accept optional teamId parameter
  - Pass team_id as query parameter
- Updated frontend components to pass team context:
  - nav-apps.tsx - uses currentTeamId from useTeamContext
  - projects/_index.tsx - filters apps by current team
  - projects/$id.tsx - filters allApps by current team
  - settings/notifications.tsx - filters apps for subscription
- Updated frontend types (frontend/app/types/api.ts)
  - Added team_id to App interface
  - Added team_id to CreateAppRequest interface
- Updated server-side API (frontend/app/lib/api.server.ts)
  - Added optional teamId parameter to getApps
- Files changed:
  - src/api/apps.rs
  - src/db/models/app.rs
  - frontend/app/components/nav-apps.tsx
  - frontend/app/lib/api/apps.ts
  - frontend/app/lib/api.server.ts
  - frontend/app/routes/projects/_index.tsx
  - frontend/app/routes/projects/$id.tsx
  - frontend/app/routes/settings/notifications.tsx
  - frontend/app/types/api.ts
- **Learnings for future iterations:**
  - Apps table already has team_id column from migration 015_teams.sql
  - Query extractor requires explicit serde::Deserialize derive on query structs
  - React Query keys should include team_id to trigger refetch on team switch
  - enabled: currentTeamId !== null prevents queries before team loads
---

## 01/10/2026 - US-004
- Added team_id field to Rust Project models (src/db/models/project.rs)
  - Added team_id to Project struct
  - Added team_id to ProjectWithAppCount DTO
  - Added team_id to ProjectWithApps DTO
  - Added team_id to CreateProjectRequest DTO
- Modified GET /api/projects endpoint (src/api/projects.rs)
  - Added ListProjectsQuery struct with optional team_id parameter
  - Filter by team_id when provided
  - Return all projects when no team_id filter (backward compatibility)
  - Support empty string team_id to get legacy/unassigned projects
- Updated project creation INSERT query to include team_id column
- Updated frontend API (frontend/app/lib/api/projects.ts)
  - Modified getProjects to accept optional teamId parameter
  - Pass team_id as query parameter
- Updated frontend pages to pass team context:
  - projects/_index.tsx - passes currentTeamId to getProjects and createProject
  - projects/$project-id.apps.new.tsx - filters projects by current team for dropdown
- Updated frontend types (frontend/app/types/api.ts)
  - Added team_id to Project interface
  - Added team_id to CreateProjectRequest interface
- Updated server-side API (frontend/app/lib/api.server.ts)
  - Added optional teamId parameter to getProjects
- Files changed:
  - src/api/projects.rs
  - src/db/models/project.rs
  - frontend/app/lib/api/projects.ts
  - frontend/app/lib/api.server.ts
  - frontend/app/routes/projects/_index.tsx
  - frontend/app/routes/projects/$project-id.apps.new.tsx
  - frontend/app/types/api.ts
- **Learnings for future iterations:**
  - Projects table already has team_id column from migration 015_teams.sql (same as apps)
  - Pattern for team filtering is consistent: add ListXxxQuery struct, optional team_id, use match expression
  - Frontend pattern: add teamId param to API function, include in query key, set enabled: currentTeamId !== null
---

## 01/10/2026 - US-005
- Created migration 032_databases_team.sql
  - Added team_id column to databases table
  - Created index idx_databases_team_id for faster lookups
- Added team_id field to Rust ManagedDatabase model (src/db/models/database.rs)
  - Added team_id to ManagedDatabase struct
  - Added team_id to ManagedDatabaseResponse DTO
  - Added team_id to CreateManagedDatabaseRequest DTO
  - Updated to_response method to include team_id
- Modified GET /api/databases endpoint (src/api/databases.rs)
  - Added team_id to ListQuery struct
  - Filter by team_id when provided
  - Return all databases when no team_id filter (backward compatibility)
  - Support empty string team_id to get legacy/unassigned databases
- Updated database creation INSERT query to include team_id column
- Updated frontend API (frontend/app/lib/api/databases.ts)
  - Modified getDatabases to accept options object with optional teamId
  - Pass team_id as query parameter using URLSearchParams
- Updated frontend pages to pass team context:
  - projects/_index.tsx - passes currentTeamId to getDatabases
  - projects/$id.tsx - passes currentTeamId to createDatabase
- Updated frontend types (frontend/app/types/api.ts)
  - Added team_id to ManagedDatabase interface
  - Added team_id to CreateManagedDatabaseRequest interface
- Updated server-side API (frontend/app/lib/api.server.ts)
  - Modified getDatabases to accept options object with teamId
- Files changed:
  - migrations/032_databases_team.sql (new)
  - src/api/databases.rs
  - src/db/models/database.rs
  - frontend/app/lib/api/databases.ts
  - frontend/app/lib/api.server.ts
  - frontend/app/routes/projects/_index.tsx
  - frontend/app/routes/projects/$id.tsx
  - frontend/app/types/api.ts
- **Learnings for future iterations:**
  - Unlike apps and projects, databases table did NOT have team_id column - required new migration
  - getDatabases needed signature change from (reveal, token) to (options, token) to add teamId
  - Pattern is consistent with apps/projects: ListQuery struct, filter by team_id, frontend passes currentTeamId
---

## 01/10/2026 - US-006
- Created migration 033_services_team.sql
  - Added team_id column to services table
  - Created index idx_services_team_id for faster lookups
- Added team_id field to Rust Service model (src/db/models/service.rs)
  - Added team_id to Service struct
  - Added team_id to ServiceResponse DTO
  - Added team_id to CreateServiceRequest DTO
  - Updated From<Service> for ServiceResponse implementation
- Modified GET /api/services endpoint (src/api/services.rs)
  - Added ListServicesQuery struct with optional team_id parameter
  - Filter by team_id when provided
  - Return all services when no team_id filter (backward compatibility)
  - Support empty string team_id to get legacy/unassigned services
- Updated service creation INSERT query to include team_id column
- Updated frontend API (frontend/app/lib/api/services.ts)
  - Added GetServicesOptions interface with optional teamId
  - Modified getServices to accept options object and pass team_id query param
- Updated frontend page to pass team context:
  - services/_index.tsx - uses currentTeamId from useTeamContext
  - Passes currentTeamId to getServices query
  - Passes team_id in createService mutation
- Updated frontend types (frontend/app/types/api.ts)
  - Added team_id to Service interface
  - Added team_id to CreateServiceRequest interface
- Updated server-side API (frontend/app/lib/api.server.ts)
  - Modified getServices to accept options object with teamId
- Files changed:
  - migrations/033_services_team.sql (new)
  - src/api/services.rs
  - src/db/models/service.rs
  - frontend/app/lib/api/services.ts
  - frontend/app/lib/api.server.ts
  - frontend/app/routes/services/_index.tsx
  - frontend/app/types/api.ts
- **Learnings for future iterations:**
  - Services table did NOT have team_id column - required new migration (same as databases)
  - Pattern is fully consistent: ListXxxQuery struct, filter by team_id, frontend uses currentTeamId
  - Services follow exact same pattern as apps, projects, and databases for team filtering
---

## 01/10/2026 - US-007
- Created migration 034_team_invitations.sql
  - team_invitations table with id, team_id, email, role, token, expires_at, accepted_at, created_by, created_at
  - Unique index on token for fast lookups
  - Unique index on (team_id, email) WHERE accepted_at IS NULL to prevent duplicate pending invitations
- Added TeamInvitation model (src/db/models/team.rs)
  - TeamInvitation struct with is_expired() and is_accepted() helper methods
  - TeamInvitationResponse DTO with team_name and inviter_name for display
  - CreateInvitationRequest DTO for creating invitations
- Added invitation endpoints (src/api/teams.rs)
  - list_invitations: GET /api/teams/{id}/invitations - list pending invitations (admin+ only)
  - create_invitation: POST /api/teams/{id}/invitations - create invitation (admin+ only)
  - delete_invitation: DELETE /api/teams/{id}/invitations/{id} - revoke invitation
  - validate_invitation: GET /api/auth/invitations/{token} - validate invitation (public)
  - accept_invitation: POST /api/invitations/{token}/accept - accept invitation (authenticated)
- Added routes to src/api/mod.rs
  - Protected routes under /api for list, create, delete, accept
  - Public route under /api/auth for validation
- Security features:
  - 48-character secure random tokens
  - 7-day expiration
  - Email matching on accept (case-insensitive)
  - Role hierarchy enforced (admins can't assign owner role)
- Files changed:
  - migrations/034_team_invitations.sql (new)
  - src/api/teams.rs
  - src/api/mod.rs
  - src/db/mod.rs (added migration 034)
  - src/db/models/team.rs
- **Learnings for future iterations:**
  - Invitation tokens should be long (48+ chars) for security
  - Use chrono::Duration for date calculations
  - SQLite unique partial indexes (WHERE clause) work for preventing duplicate pending invitations
  - Public endpoints go in auth_routes, protected in api_routes
  - rand::rng() and random_range() for secure random generation
---
