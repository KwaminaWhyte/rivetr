# Ralph Progress Log
Started: Resource Alerts & Cost Estimation
---

## Codebase Patterns
- Container runtime abstraction is in src/runtime/mod.rs (DockerRuntime, PodmanRuntime)
- API routes use Axum in src/api/
- Database uses SQLite with SQLx, migrations in migrations/
- Frontend is React + TypeScript + shadcn/ui in frontend/
- Use anyhow::Result for error handling in Rust code
- State management uses AppState in src/lib.rs with ArcSwap for lock-free updates
- Stats collection tasks are spawned in main.rs using tokio::spawn
- Per-app metrics: ResourceMetric model in src/db/models/resource_metric.rs
- Background task pattern: spawn_*_task functions in src/engine/
- Alert configs: AlertConfig and GlobalAlertDefault models in src/db/models/alert_config.rs
- Settings API pattern: /api/settings/* for global configuration endpoints
- Alert events: AlertEvent model in src/db/models/alert_event.rs with firing/resolved status
- Alert evaluation runs alongside metrics collection in resource_metrics_collector.rs
- Hysteresis pattern: Use AlertBreachCount table to track consecutive threshold breaches
- Team notification channels: /api/teams/{id}/notification-channels endpoints, require_team_role() for access control
- Webhook config: WebhookConfig in src/db/models/notification.rs with URL, headers, payload_template
- Alert email notifications: AlertNotificationService in src/notifications/alert_notifications.rs
- Email queue pattern: Use tokio mpsc channel to prevent blocking (see spawn_alert_notification_worker)
- Dashboard URL for emails: config.server.external_url (Option<String>)
- Webhook alerts: send_alert_webhook_with_retry() with exponential backoff in alert_notifications.rs
- Payload builders: build_slack_alert_payload(), build_discord_alert_payload(), build_json_alert_payload()

---

## 2026-01-10 - US-001
- What was implemented: Per-app resource metrics collection infrastructure
- Files changed:
  - migrations/032_resource_metrics.sql (new table)
  - src/db/models/resource_metric.rs (new model with CRUD operations)
  - src/db/models/mod.rs (module registration)
  - src/engine/resource_metrics_collector.rs (new collector service)
  - src/engine/mod.rs (module registration)
  - src/main.rs (spawn collector task)
- **Learnings for future iterations:**
  - ContainerRuntime::stats() returns ContainerStats with cpu_percent, memory_usage, memory_limit
  - Existing stats_collector.rs handles system-wide stats, this new module handles per-app
  - Deployment table has container_id field for looking up container stats
  - Use tokio::select! for multiple interval tasks in single spawn
  - 2 pre-existing test failures in pack_builder and preview modules (unrelated)
---

## 2026-01-10 - US-002
- What was implemented: Alert configuration models and API for threshold-based resource alerts
- Files changed:
  - migrations/033_alert_configs.sql (new tables: alert_configs, global_alert_defaults)
  - src/db/models/alert_config.rs (new model with CRUD operations)
  - src/db/models/mod.rs (module registration)
  - src/api/alerts.rs (new API endpoints)
  - src/api/mod.rs (module registration and route definitions)
- **Learnings for future iterations:**
  - Per-app alert configs are stored in alert_configs table with app_id foreign key
  - Global defaults are stored in global_alert_defaults table (seeded with default thresholds)
  - AlertConfig::get_effective_threshold() returns per-app config if exists, else global default
  - API endpoints follow existing patterns: list/create/get/update/delete at /api/apps/{id}/alerts
  - Settings endpoints at /api/settings/alert-defaults for global defaults
  - Use StatusCode::CONFLICT for duplicate constraint violations
---

## 2026-01-10 - US-003
- What was implemented: Alert evaluation engine with hysteresis and duplicate prevention
- Files changed:
  - migrations/034_alert_events.sql (new tables: alert_events, alert_breach_counts)
  - src/db/models/alert_event.rs (AlertEvent and AlertBreachCount models)
  - src/db/models/mod.rs (module registration)
  - src/engine/alert_evaluator.rs (AlertEvaluator service)
  - src/engine/mod.rs (module registration)
  - src/engine/resource_metrics_collector.rs (integrated alert evaluation)
- **Learnings for future iterations:**
  - Hysteresis: HYSTERESIS_THRESHOLD=2 requires 2 consecutive breaches before triggering
  - AlertBreachCount table tracks consecutive_count per app/metric using upsert pattern
  - AlertEvent.should_notify() checks 15-minute window via last_notified_at field
  - Alert evaluation runs after each metrics collection cycle in resource_metrics_collector
  - AlertEvaluator.evaluate_all() queries distinct app_ids from recent metrics
  - Memory percentage calculated as: (memory_bytes / memory_limit_bytes) * 100.0
  - Resolved alert cleanup uses 7-day retention (DEFAULT_ALERT_EVENT_RETENTION_HOURS=168)
---

## 2026-01-10 - US-004
- What was implemented: Team-scoped notification channel configuration with webhook support
- Files changed:
  - migrations/035_team_notification_channels.sql (adds team_id to notification_channels)
  - src/db/models/notification.rs (added Webhook channel type, WebhookConfig, team_id field)
  - src/api/notifications.rs (team-scoped CRUD endpoints, webhook URL validation)
  - src/api/mod.rs (registered team notification channel routes)
  - src/notifications/mod.rs (added send_webhook method with multiple payload templates)
- **Learnings for future iterations:**
  - Existing notification_channels table extended with team_id column (nullable for global channels)
  - Team-scoped endpoints at /api/teams/{id}/notification-channels with role-based access (Admin+)
  - Webhook validation requires HTTPS, uses reqwest::Url::parse for URL format validation
  - WebhookConfig supports payload_template: "json", "slack", "discord", "custom"
  - Custom templates support variable substitution: {{app_name}}, {{metric_type}}, {{value}}, etc.
  - Sensitive headers (containing auth/secret/token/key) are masked in API responses
  - Use require_team_role() helper for team permission checks (pattern from teams.rs)
  - 2 pre-existing test failures in pack_builder and preview modules (unrelated)
---

## 2026-01-10 - US-005
- What was implemented: Email notification sender for resource alerts
- Files changed:
  - src/notifications/alert_notifications.rs (new AlertNotificationService with email queue)
  - src/notifications/mod.rs (module export)
  - src/engine/alert_evaluator.rs (integrated notification service, added with_notifications constructor)
  - src/engine/resource_metrics_collector.rs (spawns notification worker, passes dashboard_url)
  - src/main.rs (updated to use spawn_resource_metrics_collector_task_with_notifications)
- **Learnings for future iterations:**
  - Alert emails use existing SMTP infrastructure from notification channels (EmailConfig)
  - AlertNotificationPayload wraps AlertEvent with app_name and dashboard_url for templates
  - Email queue uses tokio mpsc channel (capacity 100) to prevent blocking alert evaluation
  - spawn_alert_notification_worker runs in background processing queued emails
  - HTML email template includes severity-based colors (critical=red, warning=orange, info=blue, resolved=green)
  - Dashboard link uses config.server.external_url when configured
  - Re-notifications sent for ongoing alerts after 15-minute window (checked by should_notify())
  - 2 pre-existing test failures in pack_builder and preview modules (unrelated)
---

## 2026-01-10 - US-006
- What was implemented: Webhook notification sender with retry logic and default templates
- Files changed:
  - src/notifications/alert_notifications.rs (extended with webhook support)
- **Learnings for future iterations:**
  - AlertNotificationCommand enum now has SendEmail and SendWebhook variants
  - queue_email_alert() and queue_webhook_alert() methods on AlertNotificationService
  - get_webhook_channels() fetches all enabled webhook channels from notification_channels table
  - send_alert_webhook_with_retry() implements 3 attempts with exponential backoff (1s, 2s, 4s)
  - Webhook payload templates: "json", "slack", "discord", "custom"
  - Slack uses :warning:, :rotating_light:, :white_check_mark: emojis for severity
  - Discord uses unicode emojis and integer color values (hex parsed to i32)
  - Custom templates support {{app_name}}, {{metric_type}}, {{value}}, {{threshold}}, {{severity}}, {{status}}, {{dashboard_url}}
  - 2 pre-existing test failures in pack_builder and preview modules (unrelated)
---

